define(function(require) {
  'use strict';

  var Route = require('js/utils/route');
  var api = require('js/utils/api');

  return new Route({

    initialize: function(data) {
      return api.get('/cases')
        .bind(this)
        .then(function(cases) {
          return this.loadDashboard()
            .then(_.partial(this.loadCases, cases));
        });
    },

    loadDashboard: function() {
      return this.loadModel('dashboard/model.js')
        .then(function(modelInstance) {
          var viewData = {model: modelInstance};
          return this.loadView('dashboard/view.js', viewData);
        })
        .then(function(viewInstance) {
          viewInstance.render('dashboard', 'home');
        });
    },

    loadCases: function(cases) {
      cases = _.filter(cases, function(c) { return !c.archived; });

      var modelData = {cases: cases};
      return this.loadModel('dashboard/cases/model.js', modelData)
        .then(function(modelInstance) {
          var viewData = {model: modelInstance};
          return this.loadView('dashboard/cases/view.js', viewData);
        })
        .then(function(viewInstance) {
          viewInstance.render();
        });
    }

  });

});
