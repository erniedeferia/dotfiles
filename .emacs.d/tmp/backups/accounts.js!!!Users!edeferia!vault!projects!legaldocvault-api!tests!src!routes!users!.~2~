const chai = require('chai');
const expect = chai.expect;
const _ = require('lodash');
const express = require('express');
const request = require('supertest');

exports = module.exports = function (site, database) {
  const agent = request.agent(site);
  const bte = require('../../mixins/base-test-essentials')(site, database, agent);
  var userID;

  before(function (done) {
    var getAllUserAccounts = bte.getRoute('users/accounts/get');

    database.select('id')
      .from('users')
      .where('username', '=', bte.userFixtures.testLogin.username)
      .limit(1)
      .then(function (users) {
        if (users.length === 0) {
          return database.insert(bte.userFixtures.testLogin)
            .into('users')
            .then(function () {
              done();
            });
        } else {
          userID = users[0].id;

          done();
        }
      }).catch(done);
  });


  it('returns all accounts to which the user is associated along with the corresponding roles', function (done) {
    agent.get(bte.config.server.urlPrefix + '/users/' + userID  + '/accounts')
      .expect(200)
      .expect('Content-Type', /json/)
      .end(function (err, res) {
        if (err) {
          console.log(err);
          return done(err);
        }
        console.log("All user accounts: %o", res.body);
        expect(res.body).to.not.be.null();
        expect(res.body.length).to.be.greaterThan(0);
        done();
      });
  });

};
