xmodule DOKK
 module Email
  class GoogleConfirmationProcessor < ConfirmationProcessor

    def process(org_id,email)
       Rails.logger.info  "Processing a google confirmation email..."
       token_detected, confirmation_text = extract_confirmation_text(email)
       email_integration = EmailIntegration.for_organization(org_id).first
       email_integration.set_confirmation_text!( confirmation_text )
    end
   
    private
     # Use regex to extract the confirmation text that must be displayed to the user in
     # the email integration view in order to complete the email forwarding setup.
     # Google's email forwarding confirmation message has the subject line as:
     # (#186114359) Gmail Forwarding Confirmation
     # If the expected pattern is detected we return [true, pattern-value]
     # Else we return [false, body]
     def extract_confirmation_text(email)
       match = /\((#\d+)\) Gmail Forwarding Confirmation\b*/.match( email.subject )
       if !match.nil? then
          return true, match.captures[0]
       else
          return false, email.body
       end
     end


  end
 end
end
