require 'rails_helper'
require 'support/controller_macros'

xRSpec.configure do |c|
  c.include ControllerMacros
end

RSpec.describe Admin::SiteDocumentsController, type: :controller do
 include ControllerMacros
 extend ControllerMacros

 before :all do
   signup_user
 end

 def valid_attributes
   {
     :title => "A site-wide document",
     :description => "A site-wide document description",
     :file => fixture_file_upload("#{Rails.root}/spec/fixtures/files/testfile.pdf", 'application/pdf'),
     :type => "Guide",
     :purpose => "Email"
   }
 end

 describe "POST create" do

   it "creates a new Site Document" do
      login_sysadmin
      expect {
       post :create, {:site_document => valid_attributes  }
      }.to change(SiteDocument, :count).by(1)

   end

   it "posting a unique purpose document to be created successfully" do
      login_sysadmin
      expect {
       _attributes = valid_attributes.merge({:purpose => 'a dup purpose'})
       post :create, {:site_document => _attributes }
      }.to change(SiteDocument, :count).by(1)

   end
   it "posting a duplicate purpose document to be created successfully" do
      login_sysadmin
      expect {
       _attributes = valid_attributes.merge({:purpose => 'a dup purpose'})
       post :create, {:site_document => _attributes }
      }.to change(SiteDocument, :count).by(0)
   end

 end


 describe "GET index" do

   it "retrives a list of Site Documents" do
     login_sysadmin
     get :index
     expect(response).to render_template :index
   end
 end

 describe "GET index (by non-sysadmin)" do
  it "should redirect user to root_path" do
     login_user
     get :index
     expect(response).to redirect_to("/")
  end
 end


end
